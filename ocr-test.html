<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live OCR</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            text-align: center;
            padding: 10px;
            font-size: 1.2rem;
        }

        video {
            width: 100%;
            max-width: 480px;
            border: 1px solid #ccc;
            border-radius: 8px;
        }

        textarea {
            width: 100%;
            height: 140px;
            margin-top: 12px;
            padding: 10px;
            font-size: 1rem;
            border-radius: 6px;
            box-sizing: border-box;
        }

        .buttons {
            margin-top: 12px;
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 20px;
            font-size: 1rem;
            border-radius: 6px;
            border: none;
            background-color: #007BFF;
            color: white;
            cursor: pointer;
        }

        button:hover {
            background-color: #0056b3;
        }

        canvas {
            display: none;
        }
    </style>
</head>

<body>
    <h1>Live OCR Scanner</h1>
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" width="320" height="200"></canvas>
    <canvas id="processedCanvas" width="480" height="200" style="margin-top:10px; border:1px solid #ccc;"></canvas>
    <textarea id="output" placeholder="Recognized text appears here..."></textarea>
    <div class="buttons">
        <button id="toggleOcrBtn">Start OCR</button>
        <button id="copyBtn">Copy</button>
        <button id="flashBtn">Toggle Flashlight</button>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const output = document.getElementById('output');
        const toggleOcrBtn = document.getElementById('toggleOcrBtn');
        const copyBtn = document.getElementById('copyBtn');
        const ctx = canvas.getContext('2d');
        const intervalMs = 3000;

        let ocrInterval = null;
        let videoTrack = null;
        let flashOn = false;

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                video.srcObject = stream;

                videoTrack = stream.getVideoTracks()[0];
            } catch (err) {
                alert('Camera access denied: ' + err.message);
            }
        }


        async function performOCR() {
            const cropWidth = 480;
            const cropHeight = 200;
            const sx = (video.videoWidth - cropWidth) * 0.33333;
            const sy = (video.videoHeight - cropHeight) * 0.75;

            // Draw red crop box overlay
            const overlayCtx = video.getContext?.('2d'); // only works on canvas, not video
            if (!overlayCtx && !document.getElementById('cropOverlay')) {
                const overlay = document.createElement('div');
                overlay.id = 'cropOverlay';
                overlay.style.position = 'absolute';
                overlay.style.border = '2px solid red';
                overlay.style.width = `${cropWidth * (video.clientWidth / video.videoWidth)}px`;
                overlay.style.height = `${cropHeight * (video.clientHeight / video.videoHeight)}px`;
                overlay.style.left = `${(video.clientWidth - overlay.clientWidth) / 2}px`;
                overlay.style.top = `${(video.clientHeight - overlay.clientHeight) / 2}px`;
                overlay.style.pointerEvents = 'none';
                overlay.style.zIndex = '10';
                video.parentElement.appendChild(overlay);
            }

            // Draw cropped image onto internal canvas
            ctx.drawImage(video, sx, sy, cropWidth, cropHeight, 0, 0, canvas.width, canvas.height);

            // Binarization
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            for (let i = 0; i < data.length; i += 4) {
                const avg = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
                const val = avg > 180 ? 255 : 0;
                data[i] = data[i + 1] = data[i + 2] = val;
            }
            ctx.putImageData(imageData, 0, 0);

            // Show the processed image on a second canvas
            const processedCanvas = document.getElementById('processedCanvas');
            const processedCtx = processedCanvas.getContext('2d');
            processedCtx.putImageData(imageData, 0, 0);

            // OCR
            const { data: { text } } = await Tesseract.recognize(canvas, 'eng', {
                langPath: 'https://tessdata.projectnaptha.com/4.0.0_best',
            });
            output.value = text.trim();
        }

        function toggleOCR() {
            if (ocrInterval) {
                clearInterval(ocrInterval);
                ocrInterval = null;
                toggleOcrBtn.textContent = 'Start OCR';
            } else {
                performOCR();
                ocrInterval = setInterval(performOCR, intervalMs);
                toggleOcrBtn.textContent = 'Stop OCR';
            }
        }

        copyBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(output.value)
                .then(() => alert('Text copied!'))
                .catch(err => alert('Copy failed: ' + err));
        });

        document.getElementById('flashBtn').addEventListener('click', async () => {
            if (!videoTrack) return alert('Camera not initialized');

            const capabilities = videoTrack.getCapabilities?.();
            if (!capabilities?.torch) return alert('Flashlight not supported on this device');

            try {
                flashOn = !flashOn;
                await videoTrack.applyConstraints({ advanced: [{ torch: flashOn }] });
            } catch (err) {
                alert('Failed to toggle flashlight: ' + err.message);
            }
        });

        toggleOcrBtn.addEventListener('click', toggleOCR);
        window.onload = startCamera;
    </script>
</body>

</html>